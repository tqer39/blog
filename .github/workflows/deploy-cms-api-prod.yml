---
name: Deploy CMS API (Prod)

on:
  workflow_dispatch:
  workflow_call:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Deploy Worker
    runs-on: ubuntu-latest
    environment: production
    steps:
      - uses: actions/checkout@v6

      - uses: ./.github/actions/deploy-cms-api
        with:
          wrangler_env: prod
          placeholder: to-be-set-by-terraform
          d1_database_id: ${{ secrets.D1_DATABASE_ID_PROD }}
          cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Discord Notification (Failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "CMS API Deploy Failed (prod)"
          message: "Worker deployment to prod failed"
