---
name: Deploy (Prod)

on:
  release:
    types: [published]
  workflow_call:
  workflow_dispatch:

concurrency:
  group: deploy-prod
  cancel-in-progress: false

jobs:
  shared-infra:
    name: Shared Infrastructure
    uses: ./.github/workflows/terraform-shared.yml
    with:
      RUN_APPLY: true
    secrets: inherit

  sync-secrets:
    name: Sync Secrets
    needs: shared-infra
    uses: ./.github/workflows/sync-secrets.yml
    with:
      target: wrangler
      environment: prod
    secrets: inherit

  terraform:
    name: Terraform
    needs: sync-secrets
    uses: ./.github/workflows/terraform-prod.yml
    with:
      RUN_APPLY: true
    secrets: inherit

  db-migrate:
    name: DB Migration
    needs: terraform
    uses: ./.github/workflows/db-migrate-prod.yml
    secrets: inherit

  deploy-api:
    name: Deploy CMS API
    needs: db-migrate
    uses: ./.github/workflows/deploy-cms-api-prod.yml
    secrets: inherit

  notify-success:
    name: Notify Success
    needs: deploy-api
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v6

      - name: Discord Notification
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "Production Deploy Complete"
          message: "Tag: ${{ github.ref_name }}"
          color: "3066993"
