---
name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version (e.g., v1.2.3) - leave empty for auto-calculate"
        required: false
        type: string
        default: ""
      description:
        description: "Release description"
        required: false
        type: string
        default: ""
      auto_changelog:
        description: "Auto-update CHANGELOG.md"
        required: false
        type: boolean
        default: true

jobs:
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      version: ${{ steps.version.outputs.version }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Calculate version
        id: version
        run: |
          INPUT_VERSION="${{ inputs.version }}"
          if [ -z "$INPUT_VERSION" ]; then
            # Auto-calculate version based on conventional commits
            VERSION=$(./scripts/calculate-version.sh)
            BUMP_TYPE=$(./scripts/calculate-version.sh --bump)
            echo "Calculated version: $VERSION (bump type: $BUMP_TYPE)"
          else
            VERSION="$INPUT_VERSION"
            BUMP_TYPE="manual"
          fi

          # Validate format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION. Use v1.2.3 format."
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Check if tag exists
        run: |
          if git rev-parse "${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
            echo "::error::Tag ${{ steps.version.outputs.version }} already exists"
            exit 1
          fi

      - name: Check for changes to release
        run: |
          BUMP_TYPE="${{ steps.version.outputs.bump_type }}"
          if [ "$BUMP_TYPE" = "none" ]; then
            echo "::warning::No releasable changes found (only chore/docs/ci commits)"
            echo "Consider if a release is needed."
          fi

      - name: Get previous tag
        id: previous_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Update CHANGELOG.md
        if: ${{ inputs.auto_changelog }}
        run: |
          pnpm tsx scripts/update-changelog.ts --version "${{ steps.version.outputs.version }}"

      - name: Create PR for CHANGELOG.md
        if: ${{ inputs.auto_changelog }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if CHANGELOG.md has changes
          if git diff --quiet CHANGELOG.md; then
            echo "No changes to CHANGELOG.md"
            exit 0
          fi

          # Create branch for CHANGELOG update
          BRANCH_NAME="chore/changelog-${{ steps.version.outputs.version }}"
          git checkout -b "$BRANCH_NAME"
          git add CHANGELOG.md
          git commit -m "docs: update CHANGELOG for ${{ steps.version.outputs.version }}"
          git push -u origin "$BRANCH_NAME"

          # Create and merge PR
          PR_URL=$(gh pr create \
            --title "docs: update CHANGELOG for ${{ steps.version.outputs.version }}" \
            --body "Auto-generated CHANGELOG update for release ${{ steps.version.outputs.version }}" \
            --base main \
            --head "$BRANCH_NAME")

          echo "Created PR: $PR_URL"

          # Auto-merge the PR (requires merge queue or auto-merge enabled)
          gh pr merge "$PR_URL" --auto --squash --delete-branch || echo "Auto-merge not available, PR created for manual review"

          # Return to main branch
          git checkout main

      - name: Generate release notes
        id: changelog
        run: |
          PREV_TAG="${{ steps.previous_tag.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          # Categorize commits
          if [ -z "$PREV_TAG" ]; then
            RANGE="HEAD"
          else
            RANGE="${PREV_TAG}..HEAD"
          fi

          FEATURES=$(git log $RANGE --oneline --grep="^feat" --pretty=format:"- %s" 2>/dev/null || echo "")
          FIXES=$(git log $RANGE --oneline --grep="^fix" --pretty=format:"- %s" 2>/dev/null || echo "")
          OTHERS=$(git log $RANGE --oneline --pretty=format:"- %s" | grep -vE "^- (feat|fix)" | head -20 || echo "")

          # Create release notes
          cat > CHANGELOG_BODY.md << 'EOF'
          ## What's Changed

          ${{ inputs.description }}

          EOF

          if [ -n "$FEATURES" ]; then
            echo "### New Features" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md
            echo "$FEATURES" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md
          fi

          if [ -n "$FIXES" ]; then
            echo "### Bug Fixes" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md
            echo "$FIXES" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md
          fi

          if [ -n "$OTHERS" ]; then
            echo "### Other Changes" >> CHANGELOG_BODY.md
            echo "" >> CHANGELOG_BODY.md
            echo "$OTHERS" >> CHANGELOG_BODY.md
          fi

      - name: Create Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.version }}" \
            --title "${{ steps.version.outputs.version }}" \
            --notes-file CHANGELOG_BODY.md \
            --generate-notes

      - name: Discord Notification (Success)
        if: success()
        continue-on-error: true
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "Release Created: ${{ steps.version.outputs.version }}"
          message: "New release created. Production deployment will start automatically."
          color: "3066993"

      - name: Discord Notification (Failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "Release Creation Failed"
          message: "Failed to create release ${{ steps.version.outputs.version }}"

  deploy:
    name: Deploy to Production
    needs: release
    uses: ./.github/workflows/deploy-prod.yml
    secrets: inherit
