---
name: Sync Secrets from 1Password

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Sync target"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - github
          - wrangler

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  sync:
    name: Sync Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          # Infrastructure (GitHub only)
          CLOUDFLARE_API_TOKEN: op://blog-secrets/cloudflare-api-token/password
          CLOUDFLARE_ACCOUNT_ID: op://blog-secrets/cloudflare-account-id/password
          CLOUDFLARE_ZONE_ID: op://blog-secrets/cloudflare-zone-id/password
          VERCEL_API_TOKEN: op://blog-secrets/vercel-api-token/password
          D1_DATABASE_ID_DEV: op://blog-secrets/d1-database-id-dev/password
          D1_DATABASE_ID_PROD: op://blog-secrets/d1-database-id-prod/password
          # R2 (environment-specific)
          R2_ACCESS_KEY_ID_DEV: op://blog-secrets/r2-access-key-id-dev/password
          R2_ACCESS_KEY_ID_PROD: op://blog-secrets/r2-access-key-id-prod/password
          R2_SECRET_ACCESS_KEY_DEV: op://blog-secrets/r2-secret-access-key-dev/password
          R2_SECRET_ACCESS_KEY_PROD: op://blog-secrets/r2-secret-access-key-prod/password
          R2_PUBLIC_URL_DEV: op://blog-secrets/r2-public-url-dev/password
          R2_PUBLIC_URL_PROD: op://blog-secrets/r2-public-url-prod/password
          # AI Services (environment-specific)
          OPENAI_API_KEY_DEV: op://blog-secrets/openai-api-key-dev/password
          OPENAI_API_KEY_PROD: op://blog-secrets/openai-api-key-prod/password
          GEMINI_API_KEY_DEV: op://blog-secrets/gemini-api-key-dev/password
          GEMINI_API_KEY_PROD: op://blog-secrets/gemini-api-key-prod/password
          ANTHROPIC_API_KEY_DEV: op://blog-secrets/anthropic-api-key-dev/password
          ANTHROPIC_API_KEY_PROD: op://blog-secrets/anthropic-api-key-prod/password
          # Application (environment-specific)
          AUTH_SECRET_DEV: op://blog-secrets/auth-secret-dev/password
          AUTH_SECRET_PROD: op://blog-secrets/auth-secret-prod/password
          ADMIN_PASSWORD_HASH_DEV: op://blog-secrets/admin-password-hash-dev/password
          ADMIN_PASSWORD_HASH_PROD: op://blog-secrets/admin-password-hash-prod/password
          # Third-party (GitHub only)
          SLACK_WEBHOOK_DEV: op://blog-secrets/slack-webhook-dev/password
          SLACK_WEBHOOK_PROD: op://blog-secrets/slack-webhook-prod/password
          DISCORD_WEBHOOK_DEV: op://blog-secrets/discord-webhook-dev/password
          DISCORD_WEBHOOK_PROD: op://blog-secrets/discord-webhook-prod/password
          CODECOV_TOKEN: op://blog-secrets/codecov-token/password
          # GitHub App (GitHub only)
          GHA_APP_ID: op://blog-secrets/gha-app-id/password
          GHA_APP_PRIVATE_KEY: op://blog-secrets/gha-app-private-key/private key

      - name: Sync to GitHub Secrets
        if: inputs.target == 'both' || inputs.target == 'github'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Syncing Infrastructure Secrets"
          gh secret set CLOUDFLARE_API_TOKEN --body "$CLOUDFLARE_API_TOKEN"
          gh secret set CLOUDFLARE_ACCOUNT_ID --body "$CLOUDFLARE_ACCOUNT_ID"
          gh secret set CLOUDFLARE_ZONE_ID --body "$CLOUDFLARE_ZONE_ID"
          gh secret set VERCEL_API_TOKEN --body "$VERCEL_API_TOKEN"
          gh secret set D1_DATABASE_ID_DEV --body "$D1_DATABASE_ID_DEV"
          gh secret set D1_DATABASE_ID_PROD --body "$D1_DATABASE_ID_PROD"
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (for GitHub Actions)"
          gh secret set OPENAI_API_KEY --body "$OPENAI_API_KEY_PROD"
          gh secret set ANTHROPIC_API_KEY --body "$ANTHROPIC_API_KEY_PROD"
          echo "::endgroup::"

          echo "::group::Syncing Third-party Secrets"
          gh secret set SLACK_WEBHOOK_DEV --body "$SLACK_WEBHOOK_DEV"
          gh secret set SLACK_WEBHOOK_PROD --body "$SLACK_WEBHOOK_PROD"
          gh secret set DISCORD_WEBHOOK_DEV --body "$DISCORD_WEBHOOK_DEV"
          gh secret set DISCORD_WEBHOOK_PROD --body "$DISCORD_WEBHOOK_PROD"
          gh secret set CODECOV_TOKEN --body "$CODECOV_TOKEN"
          echo "::endgroup::"

          echo "::group::Syncing GitHub App Secrets"
          gh secret set GHA_APP_ID --body "$GHA_APP_ID"
          gh secret set GHA_APP_PRIVATE_KEY --body "$GHA_APP_PRIVATE_KEY"
          echo "::endgroup::"

          echo "GitHub Secrets sync completed"

      - name: Setup pnpm
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        run: pnpm install --frozen-lockfile

      - name: Sync to Wrangler Secrets (Dev)
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        working-directory: apps/cms-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::group::Syncing R2 Secrets (Dev)"
          printf '%s' "$R2_ACCESS_KEY_ID_DEV" | pnpm wrangler secret put R2_ACCESS_KEY_ID --env dev
          printf '%s' "$R2_SECRET_ACCESS_KEY_DEV" | pnpm wrangler secret put R2_SECRET_ACCESS_KEY --env dev
          printf '%s' "$R2_PUBLIC_URL_DEV" | pnpm wrangler secret put R2_PUBLIC_URL --env dev
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (Dev)"
          printf '%s' "$OPENAI_API_KEY_DEV" | pnpm wrangler secret put OPENAI_API_KEY --env dev
          printf '%s' "$GEMINI_API_KEY_DEV" | pnpm wrangler secret put GEMINI_API_KEY --env dev
          printf '%s' "$ANTHROPIC_API_KEY_DEV" | pnpm wrangler secret put ANTHROPIC_API_KEY --env dev
          echo "::endgroup::"

          echo "::group::Syncing Application Secrets (Dev)"
          printf '%s' "$AUTH_SECRET_DEV" | pnpm wrangler secret put AUTH_SECRET --env dev
          printf '%s' "$ADMIN_PASSWORD_HASH_DEV" | pnpm wrangler secret put ADMIN_PASSWORD_HASH --env dev
          echo "::endgroup::"

          echo "Wrangler Secrets (Dev) sync completed"

      - name: Sync to Wrangler Secrets (Production)
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        working-directory: apps/cms-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::group::Syncing R2 Secrets (Production)"
          printf '%s' "$R2_ACCESS_KEY_ID_PROD" | pnpm wrangler secret put R2_ACCESS_KEY_ID --env production
          printf '%s' "$R2_SECRET_ACCESS_KEY_PROD" | pnpm wrangler secret put R2_SECRET_ACCESS_KEY --env production
          printf '%s' "$R2_PUBLIC_URL_PROD" | pnpm wrangler secret put R2_PUBLIC_URL --env production
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (Production)"
          printf '%s' "$OPENAI_API_KEY_PROD" | pnpm wrangler secret put OPENAI_API_KEY --env production
          printf '%s' "$GEMINI_API_KEY_PROD" | pnpm wrangler secret put GEMINI_API_KEY --env production
          printf '%s' "$ANTHROPIC_API_KEY_PROD" | pnpm wrangler secret put ANTHROPIC_API_KEY --env production
          echo "::endgroup::"

          echo "::group::Syncing Application Secrets (Production)"
          printf '%s' "$AUTH_SECRET_PROD" | pnpm wrangler secret put AUTH_SECRET --env production
          printf '%s' "$ADMIN_PASSWORD_HASH_PROD" | pnpm wrangler secret put ADMIN_PASSWORD_HASH --env production
          echo "::endgroup::"

          echo "Wrangler Secrets (Production) sync completed"

      - name: Slack Notification (Failure)
        if: failure()
        uses: ./.github/actions/slack-deploy-failure
        with:
          slackWebhook: ${{ secrets.SLACK_WEBHOOK_DEV }}
          title: "Secrets Sync Failed"
          message: "Failed to sync secrets from 1Password"
