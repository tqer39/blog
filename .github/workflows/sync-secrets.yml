---
name: Sync Secrets from 1Password

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Sync target"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - github
          - wrangler

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  sync:
    name: Sync Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          # Infrastructure (GitHub only)
          CLOUDFLARE_API_TOKEN: op://blog-secrets/cloudflare-api-token/password
          CLOUDFLARE_ACCOUNT_ID: op://blog-secrets/cloudflare-account-id/password
          CLOUDFLARE_ZONE_ID: op://blog-secrets/cloudflare-zone-id/password
          VERCEL_API_TOKEN: op://blog-secrets/vercel-api-token/password
          D1_DATABASE_ID: op://blog-secrets/d1-database-id/password
          # R2 (GitHub + Wrangler)
          R2_ACCESS_KEY_ID: op://blog-secrets/r2-access-key-id/password
          R2_SECRET_ACCESS_KEY: op://blog-secrets/r2-secret-access-key/password
          R2_BUCKET_NAME: op://blog-secrets/r2-bucket-name/password
          # AI Services
          OPENAI_API_KEY: op://blog-secrets/openai-api-key/password
          GEMINI_API_KEY: op://blog-secrets/gemini-api-key/password
          ANTHROPIC_API_KEY: op://blog-secrets/anthropic-api-key/password
          # Application (Wrangler only)
          AUTH_SECRET: op://blog-secrets/auth-secret/password
          ADMIN_PASSWORD_HASH: op://blog-secrets/admin-password-hash/password
          # Third-party (GitHub only)
          SLACK_WEBHOOK: op://blog-secrets/slack-webhook/password
          CODECOV_TOKEN: op://blog-secrets/codecov-token/password
          # GitHub App (GitHub only)
          GHA_APP_ID: op://blog-secrets/gha-app-id/password
          GHA_APP_PRIVATE_KEY: op://blog-secrets/gha-app-private-key/private key

      - name: Sync to GitHub Secrets
        if: inputs.target == 'both' || inputs.target == 'github'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Syncing Infrastructure Secrets"
          gh secret set CLOUDFLARE_API_TOKEN --body "$CLOUDFLARE_API_TOKEN"
          gh secret set CLOUDFLARE_ACCOUNT_ID --body "$CLOUDFLARE_ACCOUNT_ID"
          gh secret set CLOUDFLARE_ZONE_ID --body "$CLOUDFLARE_ZONE_ID"
          gh secret set VERCEL_API_TOKEN --body "$VERCEL_API_TOKEN"
          gh secret set D1_DATABASE_ID --body "$D1_DATABASE_ID"
          echo "::endgroup::"

          echo "::group::Syncing R2 Secrets"
          gh secret set R2_ACCESS_KEY_ID --body "$R2_ACCESS_KEY_ID"
          gh secret set R2_SECRET_ACCESS_KEY --body "$R2_SECRET_ACCESS_KEY"
          gh secret set R2_BUCKET_NAME --body "$R2_BUCKET_NAME"
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets"
          gh secret set OPENAI_API_KEY --body "$OPENAI_API_KEY"
          gh secret set ANTHROPIC_API_KEY --body "$ANTHROPIC_API_KEY"
          echo "::endgroup::"

          echo "::group::Syncing Third-party Secrets"
          gh secret set SLACK_WEBHOOK --body "$SLACK_WEBHOOK"
          gh secret set CODECOV_TOKEN --body "$CODECOV_TOKEN"
          echo "::endgroup::"

          echo "::group::Syncing GitHub App Secrets"
          gh secret set GHA_APP_ID --body "$GHA_APP_ID"
          gh secret set GHA_APP_PRIVATE_KEY --body "$GHA_APP_PRIVATE_KEY"
          echo "::endgroup::"

          echo "GitHub Secrets sync completed"

      - name: Setup pnpm
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        run: pnpm install --frozen-lockfile

      - name: Sync to Wrangler Secrets
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        working-directory: apps/cms-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::group::Syncing R2 Secrets"
          printf '%s' "$R2_ACCESS_KEY_ID" | pnpm wrangler secret put R2_ACCESS_KEY_ID --env production
          printf '%s' "$R2_SECRET_ACCESS_KEY" | pnpm wrangler secret put R2_SECRET_ACCESS_KEY --env production
          printf '%s' "$R2_BUCKET_NAME" | pnpm wrangler secret put R2_BUCKET_NAME --env production
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets"
          printf '%s' "$OPENAI_API_KEY" | pnpm wrangler secret put OPENAI_API_KEY --env production
          printf '%s' "$GEMINI_API_KEY" | pnpm wrangler secret put GEMINI_API_KEY --env production
          printf '%s' "$ANTHROPIC_API_KEY" | pnpm wrangler secret put ANTHROPIC_API_KEY --env production
          echo "::endgroup::"

          echo "::group::Syncing Application Secrets"
          printf '%s' "$AUTH_SECRET" | pnpm wrangler secret put AUTH_SECRET --env production
          printf '%s' "$ADMIN_PASSWORD_HASH" | pnpm wrangler secret put ADMIN_PASSWORD_HASH --env production
          echo "::endgroup::"

          echo "Wrangler Secrets sync completed"

      - name: Slack Notification (Failure)
        if: failure()
        uses: ./.github/actions/slack-deploy-failure
        with:
          slackWebhook: ${{ secrets.SLACK_WEBHOOK }}
          title: "Secrets Sync Failed"
          message: "Failed to sync secrets from 1Password"
