---
name: Sync Secrets from 1Password

on:
  workflow_dispatch:
    inputs:
      target:
        description: "Sync target"
        required: true
        default: "both"
        type: choice
        options:
          - both
          - github
          - wrangler

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  sync:
    name: Sync Secrets
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Load secrets from 1Password
        uses: 1password/load-secrets-action@v2
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          # Infrastructure (from shared-secrets/cloudflare)
          CLOUDFLARE_API_TOKEN: op://shared-secrets/cloudflare/api-token
          CLOUDFLARE_ACCOUNT_ID: op://shared-secrets/cloudflare/account-id
          CLOUDFLARE_ZONE_ID: op://shared-secrets/cloudflare/blog-zone-id
          D1_DATABASE_ID_DEV: op://shared-secrets/cloudflare/blog-d1-database-id-dev
          D1_DATABASE_ID_PROD: op://shared-secrets/cloudflare/blog-d1-database-id-prod
          # R2 (from shared-secrets/cloudflare, R2_PUBLIC_URL only - access keys not needed with bindings)
          R2_PUBLIC_URL_DEV: op://shared-secrets/cloudflare/blog-r2-public-url-dev
          R2_PUBLIC_URL_PROD: op://shared-secrets/cloudflare/blog-r2-public-url-prod
          # AI Services (all from shared-secrets)
          OPENAI_API_KEY: op://shared-secrets/openai/blog-secret-key
          GEMINI_API_KEY: op://shared-secrets/google-ai-studio/blog-api-key
          ANTHROPIC_API_KEY: op://shared-secrets/anthropic/blog-api-key
          # Application (from blog-secrets, environment-specific)
          AUTH_SECRET_DEV: op://blog-secrets/auth-secret-dev/password
          AUTH_SECRET_PROD: op://blog-secrets/auth-secret-prod/password
          ADMIN_PASSWORD_HASH_DEV: op://blog-secrets/admin-password-hash-dev/password
          ADMIN_PASSWORD_HASH_PROD: op://blog-secrets/admin-password-hash-prod/password
          BASIC_AUTH_USER: op://blog-secrets/basic-auth-user/password
          BASIC_AUTH_PASS: op://blog-secrets/basic-auth-pass/password
          # Third-party (from blog-secrets)
          DISCORD_WEBHOOK_DEV: op://blog-secrets/discord-webhook-dev/password
          DISCORD_WEBHOOK_PROD: op://blog-secrets/discord-webhook-prod/password
          CODECOV_TOKEN: op://blog-secrets/codecov-token/password
          # Vercel (from shared-secrets/vercel)
          VERCEL_API_TOKEN: op://shared-secrets/vercel/blog-api-token
          # GitHub App (from blog-secrets)
          GHA_APP_ID: op://blog-secrets/gha-app-id/password
          GHA_APP_PRIVATE_KEY: op://blog-secrets/gha-app-private-key/private key

      - name: Sync to GitHub Secrets
        if: inputs.target == 'both' || inputs.target == 'github'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "::group::Syncing Infrastructure Secrets"
          gh secret set CLOUDFLARE_API_TOKEN --body "$CLOUDFLARE_API_TOKEN"
          gh secret set CLOUDFLARE_ACCOUNT_ID --body "$CLOUDFLARE_ACCOUNT_ID"
          gh secret set CLOUDFLARE_ZONE_ID --body "$CLOUDFLARE_ZONE_ID"
          gh secret set D1_DATABASE_ID_DEV --body "$D1_DATABASE_ID_DEV"
          gh secret set D1_DATABASE_ID_PROD --body "$D1_DATABASE_ID_PROD"
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (for GitHub Actions)"
          gh secret set OPENAI_API_KEY --body "$OPENAI_API_KEY"
          gh secret set ANTHROPIC_API_KEY --body "$ANTHROPIC_API_KEY"
          echo "::endgroup::"

          echo "::group::Syncing Third-party Secrets"
          gh secret set DISCORD_WEBHOOK_DEV --body "$DISCORD_WEBHOOK_DEV"
          gh secret set DISCORD_WEBHOOK_PROD --body "$DISCORD_WEBHOOK_PROD"
          gh secret set CODECOV_TOKEN --body "$CODECOV_TOKEN"
          echo "::endgroup::"

          echo "::group::Syncing Vercel Secrets"
          gh secret set VERCEL_API_TOKEN --body "$VERCEL_API_TOKEN"
          echo "::endgroup::"

          echo "::group::Syncing GitHub App Secrets"
          gh secret set GHA_APP_ID --body "$GHA_APP_ID"
          gh secret set GHA_APP_PRIVATE_KEY --body "$GHA_APP_PRIVATE_KEY"
          echo "::endgroup::"

          echo "GitHub Secrets sync completed"

      - name: Setup pnpm
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        run: pnpm install --frozen-lockfile

      - name: Sync to Wrangler Secrets (Dev)
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        working-directory: apps/cms-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::group::Syncing R2 Secrets (Dev)"
          printf '%s' "$R2_PUBLIC_URL_DEV" | pnpm wrangler secret put R2_PUBLIC_URL --env dev
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (Dev)"
          printf '%s' "$OPENAI_API_KEY" | pnpm wrangler secret put OPENAI_API_KEY --env dev
          printf '%s' "$GEMINI_API_KEY" | pnpm wrangler secret put GEMINI_API_KEY --env dev
          printf '%s' "$ANTHROPIC_API_KEY" | pnpm wrangler secret put ANTHROPIC_API_KEY --env dev
          echo "::endgroup::"

          echo "::group::Syncing Application Secrets (Dev)"
          printf '%s' "$AUTH_SECRET_DEV" | pnpm wrangler secret put AUTH_SECRET --env dev
          printf '%s' "$ADMIN_PASSWORD_HASH_DEV" | pnpm wrangler secret put ADMIN_PASSWORD_HASH --env dev
          printf '%s' "$BASIC_AUTH_USER" | pnpm wrangler secret put BASIC_AUTH_USER --env dev
          printf '%s' "$BASIC_AUTH_PASS" | pnpm wrangler secret put BASIC_AUTH_PASS --env dev
          echo "::endgroup::"

          echo "Wrangler Secrets (Dev) sync completed"

      - name: Sync to Wrangler Secrets (Production)
        if: inputs.target == 'both' || inputs.target == 'wrangler'
        working-directory: apps/cms-api
        env:
          CLOUDFLARE_API_TOKEN: ${{ env.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ env.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::group::Syncing R2 Secrets (Production)"
          printf '%s' "$R2_PUBLIC_URL_PROD" | pnpm wrangler secret put R2_PUBLIC_URL --env production
          echo "::endgroup::"

          echo "::group::Syncing AI Service Secrets (Production)"
          printf '%s' "$OPENAI_API_KEY" | pnpm wrangler secret put OPENAI_API_KEY --env production
          printf '%s' "$GEMINI_API_KEY" | pnpm wrangler secret put GEMINI_API_KEY --env production
          printf '%s' "$ANTHROPIC_API_KEY" | pnpm wrangler secret put ANTHROPIC_API_KEY --env production
          echo "::endgroup::"

          echo "::group::Syncing Application Secrets (Production)"
          printf '%s' "$AUTH_SECRET_PROD" | pnpm wrangler secret put AUTH_SECRET --env production
          printf '%s' "$ADMIN_PASSWORD_HASH_PROD" | pnpm wrangler secret put ADMIN_PASSWORD_HASH --env production
          echo "::endgroup::"

          echo "Wrangler Secrets (Production) sync completed"

      - name: Discord Notification (Failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_DEV }}
          title: "Secrets Sync Failed"
          message: "Failed to sync secrets from 1Password"
