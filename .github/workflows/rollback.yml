---
name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: "Target version to rollback to (e.g., v1.2.3)"
        required: true
        type: string
      confirm:
        description: "Type 'ROLLBACK' to confirm"
        required: true
        type: string
      reason:
        description: "Reason for rollback"
        required: false
        type: string
        default: ""

jobs:
  validate:
    name: Validate Rollback Request
    runs-on: ubuntu-latest
    outputs:
      proceed: ${{ steps.validate.outputs.proceed }}
    steps:
      - name: Validate confirmation
        id: validate
        run: |
          if [ "${{ inputs.confirm }}" != "ROLLBACK" ]; then
            echo "::error::Confirmation failed. You must type 'ROLLBACK' to proceed."
            echo "proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "proceed=true" >> $GITHUB_OUTPUT

      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Validate target version exists
        run: |
          VERSION="${{ inputs.target_version }}"

          # Validate format
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi

          # Check if tag exists
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "::error::Version $VERSION does not exist"
            exit 1
          fi

          echo "Target version $VERSION validated"

      - name: Get current version
        id: current
        run: |
          CURRENT=$(git describe --tags --abbrev=0 2>/dev/null || echo "none")
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"
          echo "Rolling back to: ${{ inputs.target_version }}"

  rollback:
    name: Rollback CMS API
    needs: validate
    if: needs.validate.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ inputs.target_version }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: ./.github/actions/setup-node

      - name: Install 1Password CLI
        uses: 1password/install-cli-action@v1

      - name: Load Secrets from 1Password
        uses: 1password/load-secrets-action@v3
        with:
          export-env: true
        env:
          OP_SERVICE_ACCOUNT_TOKEN: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
          CLOUDFLARE_API_TOKEN: "op://shared-secrets/cloudflare/blog-api-token"
          CLOUDFLARE_ACCOUNT_ID: "op://shared-secrets/cloudflare/account-id"

      - name: Deploy CMS API (Rollback)
        working-directory: apps/cms-api
        run: |
          echo "Rolling back CMS API to ${{ inputs.target_version }}"
          pnpm wrangler deploy --env prod

      - name: Discord Notification (Success)
        if: success()
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "Production Rollback Complete"
          message: |
            Rolled back to ${{ inputs.target_version }}
            Reason: ${{ inputs.reason || 'Not specified' }}
          color: "15158332"

      - name: Discord Notification (Failure)
        if: failure()
        uses: ./.github/actions/discord-notify
        with:
          webhookUrl: ${{ secrets.DISCORD_WEBHOOK_PROD }}
          title: "Production Rollback Failed"
          message: |
            Failed to rollback to ${{ inputs.target_version }}
            Please check the workflow logs.
          color: "15158332"

  notify-team:
    name: Notify About Rollback
    needs: [validate, rollback]
    if: always() && needs.validate.outputs.proceed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create Issue for Rollback
        if: needs.rollback.result == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const title = `[Rollback] Production rolled back to ${{ inputs.target_version }}`;
            const body = `
            ## Production Rollback Completed

            - **Target Version**: ${{ inputs.target_version }}
            - **Reason**: ${{ inputs.reason || 'Not specified' }}
            - **Triggered by**: @${{ github.actor }}
            - **Timestamp**: ${new Date().toISOString()}

            ### Action Required

            - [ ] Investigate the issue that caused the rollback
            - [ ] Create a fix for the issue
            - [ ] Deploy the fix to production

            ---
            *This issue was automatically created by the rollback workflow.*
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['rollback', 'priority:high']
            });
